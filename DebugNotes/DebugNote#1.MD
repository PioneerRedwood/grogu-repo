# ë””ë²„ê¹… ë…¸íŠ¸ #1

## ì˜¤ëŠ˜ì˜ ë””ë²„ê¹…
1. ì˜ˆì „ë¶€í„° boost-asioë¥¼ ì‚¬ìš©í•˜ë©° ê³ ë¯¼í–ˆë˜ ê²ƒì€ ì„œë²„-í´ë¼ì´ì–¸íŠ¸ ì–‘ìª½ ëª¨ë‘ í†µì‹  ë¶€ë¶„ì— ê²¹ì¹˜ëŠ” ë¶€ë¶„ì´ ìƒë‹¹í•´ì„œ ì–´ë–»ê²Œ í•˜ë©´ ì¤„ì¼ ìˆ˜ ìˆì„ê¹Œ ì˜€ìŠµë‹ˆë‹¤.
í•´ë‹¹ ê³ ë¯¼ì€ ìƒì†ì„ í†µí•´ í•´ê²°í•˜ê²Œ ëìŠµë‹ˆë‹¤.
    ```
          TcpConnection
                |
    - - - - - - - - - - - - - 
    |                       |
    ServerConnection    ClientConnection
    ```

2. boost-asio ì†Œì¼“ í†µì‹ ì— protobuf ì ìš©í•˜ê¸°
    ```C++
    // grogu-repo/chat-boost/include/chat/tcp_connection.hpp
    void ReadHeader()
        {
            boost::asio::async_read(socket_,
                boost::asio::buffer(&read_msg_.header_, sizeof(chat::message::header)),
                read_strand_.wrap([this](auto& error, size_t bytes)->void
                {
                    if (error)
                    {
                        cerr << "Error: ReadHeader() " << error << "\n";
                        return;
                    }
                    else
                    {
                        if (read_msg_.header_.size() > 0)
                        {
                            ReadBody(read_msg_.header_.size());
                        }
                        else
                        {
                            ReadHeader();
                        }
                    }
                }));
    ```
    ##### ë©”ì‹œì§€ì˜ ì½ê¸°/ì“°ê¸° êµ¬ì¡°
    ë©”ì‹œì§€ë¥¼ ì½ê±°ë‚˜ ì“°ëŠ” í”„ë¡œì„¸ìŠ¤ëŠ” ë‘ê°€ì§€ë¡œ ì´ë£¨ì–´ì ¸ ìˆìŠµë‹ˆë‹¤. ì½ê¸°/ì“°ê¸°ë¥¼ ì½ê¸°ë¡œ í†µí•©í•´ì„œ ì„¤ëª…í•©ë‹ˆë‹¤.
    - í—¤ë” ì½ê¸°: í—¤ë”ëŠ” ë©”ì‹œì§€ IDê°’ê³¼ ë°”ë””ì˜ í¬ê¸°ë¥¼ ë‹´ëŠ” ë‹¨ìˆœí•œ êµ¬ì¡°ì…ë‹ˆë‹¤. ì¼ì • í¬ê¸°ë¡œ í—¤ë”ë¥¼ ì½ì–´ë‚¸ í›„ IDë‚˜ ë°”ë”” í¬ê¸°ì— ë”°ë¼ ë°”ë””ë¥¼ ì½ê¸° ì—¬ë¶€ë¥¼ ê²°ì •í•©ë‹ˆë‹¤. 
    - ë°”ë”” ì½ê¸°: ë°”ë””ëŠ” ë©”ì‹œì§€ì˜ ë‚´ìš©ì´ ë‹´ê²¨ìˆìŠµë‹ˆë‹¤. string, vector3(ì‚¬ìš©ì ì§€ì • í˜•ì‹) ë“±ì˜ ë°ì´í„°ê°€ ë‹´ê¸°ë©° ì´ë“¤ì€ protobuf í˜•ì‹ì— ë§ê²Œ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

    ##### í”„ë¡œì„¸ìŠ¤ ë³´ì¶© ì„¤ëª…
    - `read_msg_`ëŠ” protobufë¡œ ìƒì„±í•œ ë©”ì‹œì§€ í—¤ë”ì™€ ë©”ì‹œì§€ ë°”ë””ë¡œ ì´ë£¨ì–´ì§„ ë‹¨ìˆœ êµ¬ì¡°ì²´ í´ë˜ìŠ¤ ë©¤ë²„ ë³€ìˆ˜ì…ë‹ˆë‹¤. 
    
    - boost-asioì˜ ë¹„ë™ê¸° í†µì‹ í•˜ê¸° ìœ„í•´ì„œ í•¨ìˆ˜ íŒŒë¼ë¯¸í„°ì— boost::asio::buffer(void* data, size_t size) í˜•ì‹ìœ¼ë¡œ ë°ì´í„°ë¥¼ ì½ê±°ë‚˜ ì“¸ ì£¼ì†Œ ê³µê°„ê³¼ í¬ê¸°ë¥¼ ì§€ì •í•´ì•¼ í•©ë‹ˆë‹¤.

    - `read_strand_`ëŠ” ë‹¤ì¤‘ ìŠ¤ë ˆë“œ ì‹¤í–‰ í™˜ê²½ì—ì„œ ë¹„ë™ê¸° í•¨ìˆ˜ ì‹¤í–‰ì„ ë³„ë„ì˜ ëª…ì‹œì ì¸ ë™ê¸°í™” ê³¼ì • ì—†ì´ ìˆœì°¨ì ìœ¼ë¡œ ì‹¤í–‰ì´ ë  ìˆ˜ ìˆë„ë¡ í•˜ëŠ” ê°ì²´ì…ë‹ˆë‹¤. [ì—¬ê¸°](https://www.gamedeveloper.com/programming/how-strands-work-and-why-you-should-use-them)ì— í›Œë¥­í•œ ì„¤ëª…ì´ ìˆìŠµë‹ˆë‹¤!

    ##### ë°œìƒí•œ ë¬¸ì œì 
    - ìœ„ í”„ë¡œì„¸ìŠ¤ ë³´ì¶© ì„¤ëª…ì—ì„œ ëª…ì‹œí•œ ê²ƒì²˜ëŸ¼ `read_msg_`ì™€ ê°™ì€ ì§€ì—­ ë³€ìˆ˜ ì£¼ì†Œì— ì§ì ‘ì ìœ¼ë¡œ ì†Œì¼“ìœ¼ë¡œë¶€í„° ì½ì–´ì™€ ë°ì´í„°ë¥¼ ì €ì¥í•©ë‹ˆë‹¤. ë¬¸ì œì ì€ `ì“°ê¸°`ì—ì„œ ë°œìƒí•©ë‹ˆë‹¤.

    ```C++
    // grogu-repo/grogu-chat-client/client_connection.cpp
    void ClientConnection::Send(const chat::message::Message& msg)
    {
        boost::asio::post(context_, [this, data = std::move(msg)]()->void
        {
            bool isWriting = !write_deque_.empty();
            write_deque_.push_back(data);
            if (!isWriting)
            {
                WriteHeader();
            }
        });
    }
    ```
    ##### ì“°ê¸° íë¦„
    - ì„œë²„/í´ë¼ì´ì–¸íŠ¸ ì–‘ìª½ìœ¼ë¡œ ë°ì´í„°ë¥¼ ë³´ë‚´ê¸° ìœ„í•´ì„  ë°˜ë“œì‹œ `Send()`ë¥¼ ê±°ì³ì•¼ í•©ë‹ˆë‹¤. í•´ë‹¹ í•¨ìˆ˜ëŠ” ì •ì˜í•œ ë©”ì‹œì§€ë¥¼ `const reference`ë¡œ ë„˜ê²¨ë°›ì€ ë’¤ `post()`ë¥¼ í†µí•´ `io_context`ê°ì²´ì— ë“±ë¡í•©ë‹ˆë‹¤. 
    - í•´ë‹¹ ê°ì²´ì— ë“±ë¡í•œ `post()`ì˜ ì°¨ë¡€ê°€ ëŒì•„ì˜¤ë©´ í•¸ë“¤ëŸ¬ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤. ì‚¬ì „ì— ê°ì²´ì— í•¨ìˆ˜ í•¸ë“¤ëŸ¬ë¥¼ ë“±ë¡í–ˆì„ ë•Œ `data`ë¼ëŠ” ë³€ìˆ˜ì— ì°¸ì¡° ë©”ì‹œì§€ë¥¼ `std::move()`í†µí•´ ë³µì‚¬ ì—†ì´ ì „ë‹¬í–ˆìŠµë‹ˆë‹¤. (ìì„¸í•œ ê²ƒì€ `Scott Meyers`ì˜ `Modern Effective C++11`ì˜ `Move Semantic ì±•í„°`ë¥¼ ì°¸ê³ í•˜ì‹­ì‹œì˜¤.)
    - ê·¸ë ‡ë‹¤ë©´ ì´ì œ! í•¸ë“¤ëŸ¬ê°€ ì‹¤í–‰í•˜ëŠ” ì‹œì ì—ì„œëŠ” `write_deque_`ì—ëŠ” ë©”ì‹œì§€ê°€ ë‹´ê¹ë‹ˆë‹¤.
        
    ##### ì§„ì§œ ì“°ê¸°
    ```C++
    // grogu-repo/chat-boost/include/chat/tcp_connection.hpp
    void WriteHeader()
    {
        boost::asio::async_write(socket_,
            boost::asio::buffer(&write_deque_.front().header_, sizeof(chat::message::header)),
            write_strand_.wrap([this](auto& error, size_t bytes)->void
            {
                if (error)
                {
                    cerr << "Error: WriteHeader() " << error << "\n";
                    return;
                }
                else
                {
                    if (write_deque_.front().header_.size() > 0)
                    {
                        WriteBody(write_deque_.front().header_.size());
                    }
                }
            }));
    }        
    ```
    í—¤ë”ë¥¼ ì“°ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤. `WriteHeader()`ëŠ” ë°˜ë“œì‹œ `Send()` ë‚´ì—ì„œë§Œ `Invoke`(í˜¸ì¶œ)ë©ë‹ˆë‹¤. `write_deque_`ì˜ ë§¨ ì• ë¶€ë¶„ì— ìˆëŠ” ê°’ì˜ í—¤ë”ë¥¼ ë¹„ë™ê¸° ì“°ê¸°ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤. ë§Œì•½ í—¤ë”ì— ë°”ë”” ì‚¬ì´ì¦ˆê°€ 0ì´ìƒì´ë¼ë©´ ë” ë³´ë‚¼ ê²ƒì´ ìˆëŠ” ê²ƒì´ë¯€ë¡œ ê·¸ í¬ê¸°ë§Œí¼ ë°”ë”” ë¹„ë™ê¸° ì“°ê¸°ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤. 

    ##### ë¬¸ì œì !
    - ì•„ì§ protobufê°€ ì œê³µí•˜ëŠ” C++ APIë“¤ì´ ìµìˆ™í•˜ì§€ ì•Šì•„ì„œ ì½˜ì†”ì— ìƒì„±í•´ë‚¸ ë©”ì‹œì§€ë¥¼ ì¶œë ¥í•˜ëŠ” ê²ƒë„ ì‹œê°„ì´ ê±¸ë ¸ìŠµë‹ˆë‹¤..
    - ì§€ì—­ì ìœ¼ë¡œ í•¨ìˆ˜ì—ì„œ ìƒì„±í•œ ë©”ì‹œì§€ë¥¼ `Send()`í•¨ìˆ˜ì— íŒŒë¼ë¯¸í„°ë¡œ ë„˜ê²¨ì£¼ë©´ì„œ ë°ì´í„°ê°€ ë“±ë¡ë˜ì§€ ì•Šì€ ê²ƒì¸ì§€ ì•„ë‹ˆë©´ ì•Œ ìˆ˜ ì—†ëŠ” ì´ìœ ë¡œ `string`í˜•ì‹ì˜ ë°ì´í„°ë¥¼ ë‹´ì•„ë‚´ì§€ ëª»í•˜ëŠ” ê²ƒì¸ì§€ ì‹¤ì œ ì†Œì¼“ìœ¼ë¡œ ë°ì´í„°ë¥¼ ì“°ê¸° ëª…ë ¹ì„ ìˆ˜í–‰í–ˆì„ ë•Œ ë“±ë¡ëœ ë°”ë””ì˜ ë©”ì‹œì§€ í¬ê¸°ê°€ 0ìœ¼ë¡œ ë‚˜ì™”ìŠµë‹ˆë‹¤.
    ```C++
    // grogu-repo/grogu-chat-client/client_connection.cpp
    void ClientConnection::Ping()
    {
        ping_timer_.expires_at(ping_timer_.expiry() + std::chrono::seconds(1));
        ping_timer_.async_wait([this](auto& error)->void
            {
                if (error)
                {
                    return;
                }

                // í•´ë‹¹ ì˜ì—­ì€ í˜„ì¬ ì‚¬ë¼ì¡ŒìŠµë‹ˆë‹¤.
                chat::message::Message msg;
                msg.body_.set_content("PING");
                msg.header_.set_id(1219);
                msg.header_.set_size(5); // size of PING

                Ping();
            });
    }
    ```
    - ì—¬ì „íˆ í•´ê²°ë°©ë²•ì„ ëª¨ìƒ‰í•˜ê³  ìˆëŠ” ì¤‘ì…ë‹ˆë‹¤. ì–´ì©Œë©´ ... protobufë¥¼ í¬ê¸°í•´ì•¼í•  ìˆ˜ë„.. ğŸ˜¢


